---
- hosts: web
  tasks:
   - name: Update all Ubuntu packages
     apt:
       update_cache: yes
       cache_valid_time: 3600
   - name: Install JDK11 packages
     apt:
       name: openjdk-11-jdk
       state: present
   - name: Install Apache Maven
     apt:
       name: maven
       state: present
   - name: Install Git
     apt:
       name: git
       state: present
   - name: Clone a github repository
     git:
       repo: https://github.com/boxfuse/boxfuse-sample-java-war-hello.git
       dest: /home/nar/projects/
       clone: yes
       update: yes
   - name: Running mvn package
     command: mvn clean install
     args:
        chdir: /home/nar/projects/
- hosts: app
  become: yes
  tasks:
    - name: Update all Ubuntu packages
      apt:
         update_cache: yes
         cache_valid_time: 3600
    - name: Install JDK11 packages
      apt:
         name: openjdk-11-jdk
         state: present
    - name: Install Git
      apt:
         name: git
         state: present
    - name: New group and user for Tomcat.
      shell: groupadd tomcat && useradd -s /bin/false -g tomcat -d /opt/tomcat tomcat

    - name: Installating curl.
      apt: name=curl state=latest

    - name: Downloading Apache Tomcat tar.
      shell: wget http://us.mirrors.quenda.co/apache/tomcat/tomcat-8/v8.5.56/bin/apache-tomcat-8.5.56.tar.gz
      args:
         chdir: /tmp
    - name: Creating Apache Tomcat home directory.
      command: mkdir /opt/tomcat

    - name: Extracting Apache Tomcat.
      shell: tar -xzvf /tmp/apache-tomcat-8*tar.gz -C /opt/tomcat --strip-components=1

    - name: Updating permission.
      command: "{{ item }}"
      with_items:
           - chown -R tomcat:tomcat /opt/tomcat
           - chmod -R g+r /opt/tomcat/conf
           - chmod g+x /opt/tomcat/conf

    - name: Creating service for Apache tomcat.
      file:
         path: /etc/systemd/system/tomcat.service
         state: touch
         mode: u+rwx,g-rwx,o-x

    - name: Starting Apache Tomcat service.
      service: name=tomcat state=started
